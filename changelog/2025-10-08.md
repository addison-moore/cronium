# Changelog - 2025-10-08

## [Feature] Phase-Based Execution Timing System

### Summary

Implemented comprehensive phase-based timing system to track execution overhead separately from actual script runtime. Users can now see:

- **Execution Time**: Actual script execution duration
- **Setup Time**: Infrastructure overhead (container creation, image pulls, SSH connection, runner deployment)
- **Total Duration**: Combined time including cleanup

### Backend Changes

#### SSH Executor Timing (`apps/orchestrator/`)

- Created `internal/executors/ssh/timing.go` with comprehensive phase tracking
- Integrated timing throughout SSH execution flow in `executor.go`:
  - Connection establishment timing
  - Payload creation timing
  - Runner deployment and verification timing
  - Tunnel setup timing (API mode)
  - Payload transfer timing
  - Execution phase timing
  - Cleanup phase timing
- Error paths properly record partial timing data
- Fixed metric recording to use timing durations correctly

#### API & Services (`apps/cronium-app/src/`)

- Extended `UpdateExecutionInput` interface with 11 new timing fields
- Updated execution API endpoint to process timing data from orchestrator
- Modified job service to forward timing data to log updates
- Updated logs storage modules to include timing fields in queries

#### Database Schema

- Created migration script `add-phase-timing-fields.ts` to add:
  - Executions table: 11 new columns (phase timestamps, durations, metadata)
  - Logs table: 2 new columns (executionDuration, setupDuration)
  - Performance indexes on duration columns
- Backward compatible: existing records get calculated total_duration

### Frontend Changes

#### Activity/Logs Table UI (`apps/cronium-app/src/components/activity/`)

- Updated `ActivityTable.tsx` to display timing breakdown:
  - Primary display: Script execution time (bold)
  - Secondary display: Total duration (muted text)
  - Interactive tooltip showing detailed breakdown:
    - Script Execution time
    - Setup (container/SSH) overhead
    - Cleanup/Other overhead
    - Total Duration
    - Explanatory text about timing components
- Updated Quick View dialog with timing breakdown
- Fixed ESLint issues (nullish coalescing)

### Testing

- ✅ TypeScript compilation: No errors
- ✅ ESLint validation: All files pass
- ✅ Prettier formatting: Complete
- ✅ Go compilation: Orchestrator builds successfully

### Files Modified

**Go (Orchestrator)**:

- `apps/orchestrator/internal/executors/ssh/timing.go` (created)
- `apps/orchestrator/internal/executors/ssh/executor.go`

**TypeScript (Cronium App)**:

- `apps/cronium-app/src/lib/services/execution-service.ts`
- `apps/cronium-app/src/lib/services/job-service.ts`
- `apps/cronium-app/src/app/api/internal/executions/[executionId]/update/route.ts`
- `apps/cronium-app/src/server/storage.ts`
- `apps/cronium-app/src/server/storage/modules/logs.ts`
- `apps/cronium-app/src/components/activity/ActivityTable.tsx`
- `apps/cronium-app/src/scripts/migrations/add-phase-timing-fields.ts` (created)

**Documentation**:

- `_plans/execution-time/Phase2-Implementation.md` (created)

### Benefits

1. **Transparency**: Users see actual script performance vs infrastructure overhead
2. **Performance Analysis**: Easy to identify bottlenecks in execution pipeline
3. **Caching Visibility**: Low setup times indicate cached images/runners
4. **Debugging**: Detailed phase breakdown helps troubleshoot slow executions
5. **Backward Compatible**: Existing logs still work; new executions get enhanced data

### Next Steps

- Run database migration: `pnpm tsx src/scripts/migrations/add-phase-timing-fields.ts`
- Test containerized execution timing
- Test SSH execution timing (single and multi-server)
- Verify UI displays and tooltips work correctly
- Consider adding EventLogsTab component with same timing display
- Future: Add timing charts for historical analysis

---

## [Refactor] Tool Plugin Explicit Routes (Phase 1.5 Complete)

### Summary

Implemented hybrid approach for tool plugin API routing, providing full TypeScript support while maintaining plugin architecture flexibility. Created explicit route definitions for all 7 tool plugins.

### Backend Changes

#### New Explicit Route Files (`apps/cronium-app/src/server/api/routers/tools/`)

- Created `slack-routes.ts` - Slack operations (send, testConnection)
- Created `discord-routes.ts` - Discord operations (send, testConnection)
- Created `email-routes.ts` - Email operations with nodemailer (send, testConnection)
- Created `google-sheets-routes.ts` - Google Sheets operations (testConnection)
- Created `teams-routes.ts` - Microsoft Teams operations (send, testConnection)
- Created `notion-routes.ts` - Notion operations (testConnection)
- Created `trello-routes.ts` - Trello operations (testConnection)

#### Tools Router Updates (`apps/cronium-app/src/server/api/routers/tools.ts`)

- Imported all 7 explicit route routers
- Registered routes at `tools.[pluginName]` for full TypeScript IntelliSense
- Maintained dynamic `buildPluginRouter()` at `tools.plugins` for future extensibility

### Implementation Details

#### Route Features

- **Full TypeScript Support**: Proper typing with IntelliSense and autocomplete
- **Credential Decryption**: Automatic decryption of encrypted tool credentials
- **Authentication**: All routes use `protectedProcedure` for security
- **Consistent Pattern**: All routes follow the same structure for maintainability
- **Error Handling**: Comprehensive error handling with proper TRPCError codes

#### Example Route Structure

```typescript
// Each route file includes:
- Helper function to get and decrypt credentials
- Route schemas with Zod validation
- Route implementations with error handling
- Export as createTRPCRouter for registration
```

### Routes Available

All plugins now accessible via `trpc.tools.[pluginName].*`:

- **Slack**: `trpc.tools.slack.send()`, `trpc.tools.slack.testConnection()`
- **Discord**: `trpc.tools.discord.send()`, `trpc.tools.discord.testConnection()`
- **Email**: `trpc.tools.email.send()`, `trpc.tools.email.testConnection()`
- **Google Sheets**: `trpc.tools.googleSheets.testConnection()`
- **Teams**: `trpc.tools.teams.send()`, `trpc.tools.teams.testConnection()`
- **Notion**: `trpc.tools.notion.testConnection()`
- **Trello**: `trpc.tools.trello.testConnection()`

### Component Updates

- Updated Slack plugin UI to use `trpc.tools.slack.*` instead of `trpc.integrations.*`
- Other plugins don't use tRPC directly in UI - they use plugin action executors

### Files Modified/Created

**New Files (7)**:

- `apps/cronium-app/src/server/api/routers/tools/slack-routes.ts`
- `apps/cronium-app/src/server/api/routers/tools/discord-routes.ts`
- `apps/cronium-app/src/server/api/routers/tools/email-routes.ts`
- `apps/cronium-app/src/server/api/routers/tools/google-sheets-routes.ts`
- `apps/cronium-app/src/server/api/routers/tools/teams-routes.ts`
- `apps/cronium-app/src/server/api/routers/tools/notion-routes.ts`
- `apps/cronium-app/src/server/api/routers/tools/trello-routes.ts`

**Modified Files**:

- `apps/cronium-app/src/server/api/routers/tools.ts` - Added explicit route registrations
- `apps/cronium-app/src/tools/plugins/slack/slack-plugin.tsx` - Updated to use explicit routes
- `_plans/tools/REVISED_MODULARITY_PLAN.md` - Marked Phase 1.5 as complete

### Benefits

1. **TypeScript Support**: Full IntelliSense and type checking for all plugin routes
2. **Maintainability**: Clear, explicit route definitions easier to understand than dynamic generation
3. **Backward Compatible**: Dynamic routes still available at `tools.plugins` for extensibility
4. **Migration Path**: Components can gradually migrate from deprecated integrations router
5. **Developer Experience**: Autocomplete makes it easy to discover available routes

### Testing

- ✅ TypeScript compilation: No errors in new route files
- ✅ Route registration: All 7 plugins successfully mounted
- ✅ Type checking: Full IntelliSense support confirmed
- ✅ Plugin UI: Slack plugin updated and working

### Next Steps (Phase 2)

1. Migrate remaining components from `integrations` router to explicit plugin routes
2. Remove deprecated `integrations` router completely
3. Update IntegrationTestPanel to use explicit routes
4. Remove old integration schemas if no longer needed

---

## [Refactor] Tool Plugin System - Phase 2 Complete (Remove Integrations Router)

### Summary

Successfully removed the deprecated integrations router and schemas. All plugin functionality now uses the explicit route system implemented in Phase 1.5.

### Changes Made

#### Files Deleted

- `src/server/api/routers/integrations.ts` - Removed deprecated centralized integrations router (610 lines)
- `src/shared/schemas/integrations.ts` - Removed integration schemas no longer needed

#### Files Modified

- `src/server/api/root.ts` - Removed integrations router import and registration
- All 7 plugin route files - Fixed ESLint errors and TypeScript issues:
  - Proper type casting for JSON.parse results
  - Optional chaining for safer null checks
  - Nullish coalescing (`??`) instead of logical OR (`||`)

### Linting Fixes Applied

Fixed 20 ESLint errors and 37 warnings across all plugin route files:

- ✅ Fixed unsafe `any` assignments with explicit type casts
- ✅ Applied prettier formatting consistently
- ✅ Converted logical OR to nullish coalescing for safer defaults
- ✅ Used optional chaining for cleaner null checks
- ✅ All files now pass `eslint --max-warnings=0`

### Verification

- ✅ No components use `trpc.integrations.*` calls (verified via grep)
- ✅ All plugin UI components use plugin action executors
- ✅ TypeScript compilation: No errors
- ✅ ESLint validation: All files pass with 0 warnings
- ✅ Prettier formatting: Complete

### Impact

- **Code Reduction**: Removed 610+ lines of deprecated code
- **Type Safety**: Improved with explicit type annotations
- **Maintainability**: Centralized plugin logic in explicit route files
- **Developer Experience**: Cleaner codebase, better IntelliSense

### Files Modified Summary

**Deleted (2 files)**:

- `src/server/api/routers/integrations.ts`
- `src/shared/schemas/integrations.ts`

**Modified (8 files)**:

- `src/server/api/root.ts`
- `src/server/api/routers/tools/slack-routes.ts`
- `src/server/api/routers/tools/discord-routes.ts`
- `src/server/api/routers/tools/email-routes.ts`
- `src/server/api/routers/tools/google-sheets-routes.ts`
- `src/server/api/routers/tools/teams-routes.ts`
- `src/server/api/routers/tools/notion-routes.ts`
- `src/server/api/routers/tools/trello-routes.ts`

**Documentation**:

- `_plans/tools/REVISED_MODULARITY_PLAN.md` - Marked Phase 2 as complete
