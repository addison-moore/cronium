# Changelog for 2025-07-18

- [2025-07-18] [Refactor] Implemented events.ts storage module with all event-related methods from storage.ts
  - Moved 11 Event CRUD methods: getEvent, getEventWithRelations (with optimized and simple variants), getActiveEventsWithRelations, getAllEvents, getEventsByServerId, canViewEvent, canEditEvent, createScript, updateScript, deleteScript
  - Moved 11 Conditional Action methods: getSuccessActions, getFailActions, getAlwaysActions, getConditionActions, createAction, deleteActionsByEventId, deleteSuccessEventsByScriptId, deleteFailEventsByScriptId, deleteAlwaysEventsByScriptId, deleteConditionEventsByScriptId, getConditionalActionsByEventId
  - Note: Environment variable methods (getEnvVars, createEnvVar) remain in the variables module as per the storage module architecture
  - Kept private deleteEnvVarsByEventId method in events module for deleteScript dependency
- [2025-07-18] [Refactor] Implemented workflow-execution.ts storage module with all execution tracking methods from storage.ts
  - Implemented 4 Workflow Log methods: getWorkflowLog, getWorkflowLogs, createWorkflowLog, updateWorkflowLog (lines 2026-2082)
  - Implemented 5 Workflow Execution methods: getWorkflowExecution, getWorkflowExecutions, getUserWorkflowExecutions, createWorkflowExecution, updateWorkflowExecution (lines 2085-2196)
  - Implemented 4 Workflow Execution Event methods: createWorkflowExecutionEvent, getWorkflowExecutionEvents, updateWorkflowExecutionEvent (lines 2199-2257)
  - Added proper imports for database tables, Drizzle ORM utilities, and type definitions
  - Implemented complex joins in getWorkflowExecutionEvents to include event name and type from events table
  - Fixed getUserWorkflowExecutions to properly join with workflows table for user filtering
  - Total 388 lines of fully functional code replacing stub implementation
- [2025-07-18] [Bug Fix] Fixed type error in LogsPageClient by correcting Event type mapping
  - Fixed import to use proper Event type (aliased as DbEvent) from @/shared/schema
  - Replaced non-existent 'script' field with correct 'content' field
  - Added all required Event fields with proper defaults to match database schema
  - Updated Workflow type mapping to include all required fields
  - Imported necessary enum types (EventType, EventStatus, etc.) for type-safe defaults
  - Changed hardcoded string values to use proper enum constants
- [2025-07-18] [Bug Fix] Fixed all TypeScript linting errors in script files
  - Fixed unsafe any assignments by adding proper type annotations
  - Fixed unused variables by either removing or prefixing with underscore
  - Fixed floating promises by adding void operator
  - Fixed template literal type safety issues with proper type guards and nullish coalescing
  - Fixed type-only imports using import type syntax
  - Fixed unnecessary type assertions by relying on TypeScript's type inference
  - Fixed tools.ts router to handle missing description/tags fields safely
- [2025-07-18] [Bug Fix] Fixed encrypted tool credentials parsing error
  - Added detection for encrypted strings that weren't properly marked with encrypted=true flag
  - Added check to prevent parsing base64-encoded encrypted data as JSON
  - Added warning log when credentials appear encrypted but tool.encrypted is false
  - Prevents "Unexpected token" JSON parse errors on the tools page
- [2025-07-18] [Bug Fix] Fixed missing admin functionality
  - Fixed email invitation sending in admin router by importing sendInvitationEmail function
  - Fixed resend invitation functionality to generate new token and send email
  - Fixed bulk resend invitation operation to properly handle email sending
  - Fixed registration settings by removing redundant inviteOnly field
  - Consolidated allowRegistration and openRegistration settings in backend
  - Fixed SMTP settings validation to be conditional based on enabled state
  - Fixed AI settings validation to require fields only when AI is enabled
  - Fixed admin page to properly extract settings from response wrapper
  - Updated all save functions to properly merge existing settings
- [2025-07-18] [Refactor] Removed redundant variable management from admin router
  - Removed getVariables, createVariable, updateVariable, deleteVariable from admin router
  - These functions duplicated functionality already in the variables router
  - Deleted unused VariablesTab component that was using the redundant admin endpoints
  - Regular users should use the variables router for managing their own variables
- [2025-07-18] [Bug Fix] Fixed ServiceInitializer FORBIDDEN error for non-admin users
  - Removed ServiceInitializer component that was trying to call admin-only startServices mutation
  - Removed startServices mutation from system router as it was redundant
  - Scheduler initialization already happens on-demand when needed (has duplicate prevention)
  - This fixes the console error non-admin users were seeing on login
- [2025-07-18] [Bug Fix] Fixed ActivityTable not displaying data on dashboard
  - Connected recentActivity data from API response to the ActivityTable component
  - Fixed data type mapping for activity items
  - Fixed pagination to properly slice the activity data array
  - Activity data now properly loads from the dashboard stats API endpoint
- [2025-07-18] [UI Update] Removed status badge from Tools List in modular tools manager
- [2025-07-18] [UI Update] Updated all tool plugins to use StatusBadge component instead of Badge for displaying isActive status
- [2025-07-18] [Refactor] Removed HTTP from ToolType enum and all related code
  - HTTP is an event type (like Python script, Bash script), not a tool/integration
  - Removed HTTP from ToolType enum in src/shared/schema.ts
  - Removed httpCredentialsSchema from src/shared/schemas/tools.ts
  - Removed HTTP validation cases from tools router
  - Removed HTTP test cases from tools router
  - Removed HTTP cases from IntegrationTestPanel component
  - Removed entire http router section from integrations router
  - This clarifies the distinction between event types and integration tools
- [2025-07-18] [Analysis] Created comprehensive report of tool integration points across the codebase
  - Identified tool plugin system with registry in src/tools/plugins/index.ts
  - Found 8 built-in tool plugins: Email, Slack, Discord, Google Sheets, Teams, Notion, Trello, Webhook
  - Located tool credential storage in toolCredentials table with encryption support
  - Found tool action execution system in src/lib/scheduler/tool-action-executor.ts
  - Identified API endpoints in tools, integrations, toolActionLogs, and toolActionTemplates routers
  - Found UI components: ToolsDashboard, ToolBrowser, ToolCredentialManager, ToolActionSection
  - Located runtime helper support for tools via cronium.executeToolAction()
  - Found navigation entry in dashboard layout at /dashboard/tools
  - Identified conditional actions system that uses tools for event success/failure handling
  - Located tool validation and testing at /api/test-tool-action endpoint
- [2025-07-18] [Analysis] Investigated log status update flow from PENDING to RUNNING/SUCCESS/FAILURE
  - Log creation: When a job is scheduled, a log entry is created with PENDING status (scheduler.ts)
  - Job creation: The log ID is passed to the job via executionLogId in the job payload
  - Status updates: cronium-agent calls /api/internal/jobs/[jobId]/status to update job status
  - Missing connection: Job service updates job status but doesn't update the associated log status
  - WebSocket integration: LogsWebSocketHandler has broadcastJobUpdate() to map job status to log status
  - The missing piece: Job service needs to call getLogsWebSocketHandler().broadcastJobUpdate() when job status changes
  - Current implementation: Only WebSocket broadcasts happen, but the actual log record in DB isn't updated
  - This explains why logs remain in PENDING state even when jobs complete
- [2025-07-18] [Bug Fix] Fixed TypeScript type errors in admin page and AI settings
  - Fixed SMTP settings validation schema to use optional fields to match component interface
  - Fixed AI settings validation schema to use optional fields to match component interface
  - Fixed Select component type error by providing default empty string for undefined values
  - This resolves type incompatibility between admin page save functions and component props
- [2025-07-18] [Refactor] Removed Webhook from tools system completely
  - Removed WEBHOOK from ToolType enum in src/shared/schema.ts
  - Deleted entire webhook plugin directory at src/tools/plugins/webhook
  - Removed webhook plugin registration from src/tools/plugins/index.ts
  - Removed webhook validation cases from src/server/api/routers/tools.ts
  - Removed webhook router section from src/server/api/routers/integrations.ts
  - Removed webhookSendMutation from IntegrationTestPanel.tsx
  - Removed WEBHOOK case from ToolConfig type in src/lib/advanced-types.ts
  - Removed WEBHOOK troubleshooting section from CredentialTroubleshooter.tsx
  - Fixed TypeScript errors in email-plugin.tsx by updating form schema to handle boolean fields
  - Fixed TypeScript errors in google-sheets-plugin.tsx by updating form schema and submit handler
  - Fixed duplicate scope property in teams-plugin.tsx defaultValues
  - Note: WorkflowTriggerType.WEBHOOK remains as it's for triggering workflows via webhooks, not for webhook as a tool
- [2025-07-18] [Feature] Implemented Phase 2.1 of Tool Modularity Plan - Plugin API Route Definition
  - Added apiRoutes property to ToolPlugin interface as optional PluginApiRoutes
  - Created comprehensive route handler type definitions including:
    - PluginRouteContext for route handler context (userId, toolId, tool)
    - PluginRouteHandler with input/output schemas and handler function
    - PluginApiRoute with path, method, description, and auth requirements
    - Standard API response types (PluginApiSuccess, PluginApiError)
  - Created api-routes.ts file for each plugin with route definitions:
    - Email: testConnection, send, bulkSend, validateCredentials
    - Slack: testConnection, send, listChannels, validateCredentials
    - Discord: testConnection, send, validateCredentials
    - Google Sheets: testConnection, validateCredentials
    - Teams: testConnection, validateCredentials
    - Notion: testConnection, validateCredentials
    - Trello: testConnection, validateCredentials
  - Updated all 7 tool plugins to import and include their apiRoutes
  - All route handlers include proper input/output validation using Zod schemas
  - Mock implementations provided for all handlers (to be replaced in Phase 2.3)
- [2025-07-18] [Feature] Implemented Phase 2.2 of Tool Modularity Plan - Dynamic Route Registration
  - Created plugin-router.ts that dynamically builds tRPC routes from ToolPluginRegistry
  - Implemented createPluginProcedure function that:
    - Wraps plugin route handlers with proper authentication
    - Verifies tool ownership and type matching
    - Handles tool credential decryption
    - Provides proper error handling and audit logging
    - Validates input/output with plugin-provided schemas
  - Added buildPluginRouter function that:
    - Iterates through all registered plugins
    - Creates sub-routers for each plugin's API routes
    - Returns a complete tRPC router with all plugin routes
  - Integrated plugin router into tools router as `tools.plugins` sub-router
  - Added getPluginRouteMetadata function for route documentation
  - Plugin routes now accessible at: tools.plugins.[pluginId].[routeName]
  - Example: tools.plugins.email.testConnection, tools.plugins.slack.send
  - All routes protected by default with user authentication
  - Routes verify tool ownership and active status when required
- [2025-07-18] [Feature] Implemented Phase 2.3 of Tool Modularity Plan - API Migration
  - Migrated actual implementations from integrations router to plugin routes:
    - Email: Implemented real SMTP connection test using nodemailer
    - Email: Implemented real email sending using sendEmail function from lib/email
    - Email: Implemented bulk email sending with proper error handling
    - Slack: Implemented real webhook test and message sending
    - Discord: Implemented real webhook test and message sending
  - Updated IntegrationTestPanel to use new plugin routes:
    - Added separate test mutations for each plugin type
    - Updated test logic to use plugin-specific routes
    - Maintained fallback to legacy routes for other tool types
  - Added deprecation warnings to all integrations router endpoints:
    - Console warnings when deprecated endpoints are used
    - Clear migration path in comments and warning messages
    - Examples: integrations.slack.send -> tools.plugins.slack.send
  - All plugin routes now use actual implementations instead of mocks
  - Maintained backward compatibility during transition period
- [2025-07-18] [Bug Fix] Fixed nodemailer import error in email plugin
  - Removed direct nodemailer import from email api-routes.ts
  - Nodemailer is a Node.js-only module that can't be imported in client-side code
  - Updated testConnection handler to validate configuration without using nodemailer directly
  - The actual SMTP connection test happens server-side in the sendEmail function
  - Added emailCredentialsSchema import for validateCredentials handler
- [2025-07-18] [Bug Fix] Fixed nodemailer import error using dynamic imports
  - Updated email plugin handlers to use dynamic import() for server-only modules
  - Changed `import { sendEmail } from "@/lib/email"` to `await import("@/lib/email")`
  - This allows the api-routes.ts file to be imported client-side without build errors
  - The dynamic imports only execute when handlers run on the server in tRPC context
- [2025-07-18] [Bug Fix] Fixed email plugin by moving server-side logic to plugin router
  - Removed all server-side imports and logic from email api-routes.ts
  - Plugin api-routes now only define route schemas and return stub responses
  - Added special handling for email plugin in plugin-router.ts
  - Email plugin routes (testConnection, send, bulkSend) now execute server-side in the router
  - This completely separates client-side plugin definition from server-side execution
  - Prevents nodemailer and other Node.js modules from being bundled client-side
- [2025-07-18] [Feature] Implemented Phase 3.1 of Tool Modularity Plan - Remove Hardcoded Tool Types
  - Removed ToolType enum from src/shared/schema.ts
  - Changed toolCredentials.type column from enum to string type (varchar remains the same)
  - Updated all ToolType imports and references across 17 files:
    - tools router: Changed type parameter from ToolType to string
    - integrations router: Replaced ToolType enum values with string literals
    - IntegrationTestPanel: Updated switch cases to use string values
    - schemas/tools: Changed type validation from z.nativeEnum to z.string
    - CredentialTroubleshooter: Changed Record<ToolType> to Record<string>
    - advanced-types: Updated ToolConfig generic constraint and conditional types
  - Created migration documentation script (no data migration needed)
  - Database values remain unchanged as they were already stored as strings
- [2025-07-18] [Bug Fix] Fixed remaining ToolType import errors
  - Removed ToolType import from event-handlers.ts that was causing build error
  - Updated event-handlers.ts to use string literals ("EMAIL", "SLACK", "DISCORD") instead of enum
  - Fixed ConditionalActionsSection.tsx to remove ToolType import and type assertions
- [2025-07-18] [Bug Fix] Fixed multiple TypeScript type errors across the codebase
  - Fixed type conversion error in DashboardStats.tsx by adding Array.isArray check before casting
  - Fixed missing onEventFork property in ServerEventsList.tsx by adding it to EventsTable props
  - Fixed optional property type issues in job-service.ts by using spread operator conditionally
  - Fixed exitCode property error by removing it from logs table update (field doesn't exist)
  - Fixed eventServers property error in events router by using correct 'servers' property
  - Fixed exactOptionalPropertyTypes error in job-service by building update object conditionally
- [2025-07-18] [Feature] Implemented Phase 3.3 of Tool Modularity Plan - Conditional Actions Refactoring
  - Updated ConditionalActionsSection to remove hardcoded icon and name switches
  - Tool icons now come from plugin definitions via ToolPluginRegistry
  - Tool names now come from plugin definitions with fallback to tool type
  - Removed hardcoded EMAIL/SLACK/DISCORD parameter checks
  - Created dynamic field detection using hasActionParameter helper
  - Added getMessageEditorLanguage to dynamically determine editor mode (json/html)
  - Added getMessageHelpText to provide dynamic help text based on action parameters
  - Updated email-specific fields to show based on parameter presence ("to", "subject", "body")
  - Made message field label dynamic based on whether action has "body" parameter
  - Updated event-handlers.ts to use more generic parameter mapping
  - Maintained backward compatibility with existing conditional action data
- [2025-07-18] [Analysis] Traced complete log flow from container execution to Cronium backend
  - Container Execution: Orchestrator uses Docker API to stream stdout/stderr from containers
  - Log Streaming: Container logs are captured line-by-line via UpdateTypeLog events in the orchestrator
  - Real-time Updates: Logs are sent via WebSocket through LogStreamer for real-time UI updates
  - Log Accumulation: Orchestrator accumulates all stdout/stderr into string builders during execution
  - Job Completion: When job completes, orchestrator sends accumulated logs to /api/internal/jobs/[id]/complete
  - API Storage: Complete endpoint receives stdout/stderr in Output object and stores in job.result.output
  - Database Storage: Job result contains final output, but individual log entries may also be stored in logs table
  - WebSocket Broadcasting: Job service updates trigger WebSocket broadcasts via LogsWebSocketHandler
  - Missing Link: The updateJobStatus method in job-service.ts properly updates log status and broadcasts updates
  - Two-phase Process: Real-time streaming during execution + final complete output at job completion
- [2025-07-18] [Bug Fix] Fixed job execution logs remaining in PENDING status when jobs complete
- [2025-07-18] [Feature] Added real-time WebSocket updates for log status changes
- [2025-07-18] [Feature] Added duration calculation for completed jobs
- [2025-07-18] [Bug Fix] Fixed missing output in execution logs
- [2025-07-18] [Refactor] Updated job service to sync job and log status atomically
- [2025-07-18] [Feature] Added support for TIMEOUT and PARTIAL log statuses
- [2025-07-18] [Feature] Added comprehensive error handling and cleanup for container execution failures
- [2025-07-18] [Feature] Implemented automatic cleanup of Docker networks and containers after job completion
- [2025-07-18] [Feature] Added recovery mechanism for orchestrator crashes/restarts with orphaned job handling
- [2025-07-18] [Feature] Added periodic cleanup of orphaned Docker resources (30-minute intervals)
- [2025-07-18] [Feature] Added API endpoints for orphaned job recovery and job release
