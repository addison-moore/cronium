# Changelog - 2025-07-15

## Database Performance Optimization - Phase 1.3

- [2025-07-15] [Feature] Created optimized dashboard service at src/lib/services/dashboard-service.ts implementing Phase 1.2 query optimization recommendations
- [2025-07-15] [Refactor] Updated dashboard.getStats endpoint to use new dashboard service, eliminating N+1 queries and reducing from 200+ queries to ~10 queries
- [2025-07-15] [Refactor] Updated dashboard.getRecentActivity endpoint to use optimized dashboard service with parallel queries
- [2025-07-15] [Performance] Dashboard stats now execute all queries in parallel using Promise.all for better performance
- [2025-07-15] [Performance] Implemented single aggregated query for execution stats instead of fetching all logs and filtering in memory
- [2025-07-15] [Performance] Created efficient event name lookup map to avoid N+1 pattern when formatting recent activity

## Documentation

- [2025-07-15] [Documentation] Created comprehensive performance improvement brainstorming document at plans/performance/Brainstorm.md
- [2025-07-15] [Analysis] Identified critical N+1 database query issue in getEventWithRelations() making 8-10 queries per event
- [2025-07-15] [Analysis] Found three overlapping loading components (Spinner, LoadingState, LoadingIndicator) causing UI inconsistency
- [2025-07-15] [Analysis] Discovered heavy JavaScript bundles due to Monaco Editor, XTerm.js, and XyFlow being loaded on every page
- [2025-07-15] [Analysis] Identified excessive client-side rendering in dashboard pages that could benefit from Server Components
- [2025-07-15] [Documentation] Created comprehensive database performance improvement plan at plans/performance/DB_PERFORMANCE_PLAN.md with 5 implementation phases
- [2025-07-15] [Analysis] Completed Phase 1.1 N+1 query audit - identified 8 critical N+1 patterns affecting dashboard, event lists, and scheduler
- [2025-07-15] [Documentation] Created N+1 query audit report at plans/performance/n1-query-audit.md documenting all patterns and performance impacts
- [2025-07-15] [Bug Fix] Fixed prettier formatting issues in src/app/api/internal/jobs/[jobId]/complete/route.ts
- [2025-07-15] [Documentation] Created phase 1.1 summary at plans/performance/phase-1.1-n1-query-audit-summary.md

## Container Orchestration

- [2025-07-15] [Bug Fix] Fixed container log capture issue in orchestrator where logs were being lost due to race condition between log streaming and job completion
- [2025-07-15] [Refactor] Added synchronization to container executor using sync.WaitGroup to ensure all logs are collected before marking job as complete
- [2025-07-15] [Feature] Created alternative log collection method that retrieves all logs after container stops for guaranteed log capture
- [2025-07-15] [Bug Fix] Fixed API endpoint to handle both string and object formats for job output from orchestrator
- [2025-07-15] [Testing] Created comprehensive test scripts for runtime helper functions - verified container execution and log capture working
- [2025-07-15] [Documentation] Completed Phase 3.2 of runtime helpers implementation - documented test results and identified execution ID mismatch issue preventing runtime API calls

## Monaco Editor Usage Analysis

- [2025-07-15] [Analysis] Identified all files using Monaco Editor dependency (@monaco-editor/react)

### Summary of Monaco Editor Usage:

1. **Package Dependencies:**
   - `@monaco-editor/react` version ^4.7.0 in package.json
   - Also imports types from `monaco-editor` package

2. **Main Wrapper Component:**
   - `/src/components/ui/monaco-editor.tsx` - Central MonacoEditor component that wraps @monaco-editor/react

3. **Components Using MonacoEditor (via the wrapper):**
   - `/src/components/event-form/ConditionalActionsSection.tsx` - For editing conditional logic
   - `/src/components/event-form/EventForm.tsx` - For editing event scripts
   - `/src/components/event-form/ActionParameterForm.tsx` - For action parameter editing
   - `/src/components/tools/templates/TemplateActionParameterForm.tsx` - For template action parameters
   - `/src/components/event-details/EventDetailsTab.tsx` - For displaying event details
   - `/src/components/dashboard/AIScriptAssistant.tsx` - For AI-assisted script editing

4. **Direct Monaco Editor Usage:**
   - `/src/components/dashboard/CodeEditor.tsx` - Imports Editor directly from @monaco-editor/react

5. **Other Files with Monaco References:**
   - `/src/components/workflows/WorkflowCanvas.tsx` - Contains Monaco-related code
   - `/src/app/[lang]/docs/templates/page.tsx` - Documentation references
   - `/src/app/[lang]/docs/tools/page.tsx` - Documentation references
   - `/src/components/terminal/Terminal.tsx` - Terminal component (may have Monaco references)
   - `/src/__tests__/components/event-form/EventForm.test.tsx` - Test file

### Key Observations:

- Monaco Editor is primarily used for code editing functionality throughout the application
- Most components use the wrapper component at `/src/components/ui/monaco-editor.tsx`
- The wrapper provides TypeScript/JavaScript intellisense with Cronium-specific runtime helpers
- Monaco is a heavy dependency that significantly impacts bundle size

## XyFlow/ReactFlow Usage Analysis

- [2025-07-15] [Analysis] Identified all files using XyFlow/ReactFlow dependency (@xyflow/react)

## Code Splitting & Performance Optimization

- [2025-07-15] [Planning] Created comprehensive CODE_SPLITTING_PLAN.md for performance improvements with 6 phases
- [2025-07-15] [Feature] Set up Next.js Bundle Analyzer for measuring bundle sizes
- [2025-07-15] [Documentation] Created heavy-components-inventory.md documenting all components using Monaco, XTerm, and XyFlow
- [2025-07-15] [Documentation] Created bundle-analysis-setup.md with instructions for analyzing bundle sizes
- [2025-07-15] [Documentation] Created lazy-loading-candidates.md with prioritized list of components for lazy loading
- [2025-07-15] [Analysis] Completed Phase 1.1 of code splitting plan - component analysis and bundle setup
- [2025-07-15] [Bug Fix] Fixed ESM module import issue in next.config.mjs for bundle analyzer
- [2025-07-15] [Documentation] Created phase-1.1-component-analysis-summary.md documenting completion of Phase 1.1

### Summary of XyFlow/ReactFlow Usage:

1. **Package Dependencies:**
   - `@xyflow/react` version ^12.8.1 in package.json

2. **Components Using XyFlow/ReactFlow:**
   - **Action Builder Components:**
     - `/src/components/action-builder/ActionBuilder.tsx` - Main action builder component with ReactFlowProvider
     - `/src/components/action-builder/Canvas.tsx` - Canvas component with full ReactFlow implementation
     - `/src/components/action-builder/ActionNode.tsx` - Custom node type for actions
     - `/src/components/action-builder/ActionEdge.tsx` - Custom edge type for action connections
     - `/src/components/action-builder/useActionBuilder.ts` - Hook for action builder state management
     - `/src/components/action-builder/types.ts` - Type definitions for action builder
   - **Workflow Components:**
     - `/src/components/workflows/WorkflowCanvas.tsx` - Main workflow canvas with ReactFlow (1108 lines)
     - `/src/components/workflows/WorkflowForm.tsx` - Form component that includes WorkflowCanvas
     - `/src/components/workflows/nodes/EventNode.tsx` - Custom node component for workflow events
     - `/src/components/workflows/edges/ConnectionEdge.tsx` - Custom edge component for workflow connections
   - **Page Components:**
     - `/src/app/[lang]/dashboard/workflows/[id]/page.tsx` - Workflow detail page
     - `/src/app/[lang]/dashboard/workflows/new/page.tsx` - New workflow page
     - `/src/app/[lang]/dashboard/workflows/[id]/edit/page.tsx` - Edit workflow page

3. **API/Backend References:**
   - `/src/server/api/routers/workflows.ts` - Workflow API router (likely handles workflow data)
   - `/src/shared/schemas/workflows.ts` - Workflow schema definitions

### Key Observations:

- XyFlow/ReactFlow is used for two main features: Action Builder and Workflow Canvas
- The library provides the visual flow/graph editing capabilities for creating workflows
- Custom node and edge components are implemented for both action builder and workflows
- WorkflowCanvas is the largest component (1108 lines) suggesting it's a core feature
- The library is essential for the workflow visualization and editing functionality

## Database Performance Plan Updates

- [2025-07-15] [Documentation] Updated DB_PERFORMANCE_PLAN.md based on N+1 query audit findings
- [2025-07-15] [Documentation] Added specific priority for critical functions like getEventWithRelations() and getAllEvents()
- [2025-07-15] [Documentation] Updated success metrics with specific performance targets from audit (95-98% improvements)
- [2025-07-15] [Documentation] Added additional recommendations section covering immediate actions, query patterns, scheduler optimization, and connection management
- [2025-07-15] [Documentation] Expanded index recommendations to include event_servers, workflow_nodes, and workflow_connections tables

## Runtime Helpers Implementation

- [2025-07-15] [Feature] Created internal API endpoints for runtime helper support:
  - Added execution context endpoint at `/api/internal/executions/[executionId]/context`
  - Added variable get/set endpoints at `/api/internal/variables/[userId]/[key]`
  - Added output save endpoint at `/api/internal/executions/[executionId]/output`
  - Added condition save endpoint at `/api/internal/executions/[executionId]/condition`
  - Added audit logging endpoint at `/api/internal/audit`
- [2025-07-15] [Bug Fix] Fixed JWT token field naming mismatch between orchestrator and runtime API (snake_case to camelCase)
- [2025-07-15] [Bug Fix] Added missing userId and eventId fields to JWT token generation in orchestrator
- [2025-07-15] [Feature] Made @next/bundle-analyzer optional in next.config.mjs to prevent startup failures
- [2025-07-15] [Documentation] Created phase summaries for runtime helper implementation phases 3.1, 3.2, and 3.3
- [2025-07-15] [Refactor] Updated orchestrator JWT generation to include job metadata for user and event IDs

## Phase 3.4: Error Handling Implementation

- [2025-07-15] [Feature] Implemented error.tsx files for all major routes providing consistent error boundaries
- [2025-07-15] [Feature] Created reusable ErrorBoundaryCard component for unified error display across the application
- [2025-07-15] [Feature] Created SuspenseErrorBoundary component with automatic retry mechanism for failed suspense operations
- [2025-07-15] [Feature] Implemented streaming-specific error handling with StreamRetryWrapper and RSCStreamBoundary components
- [2025-07-15] [Feature] Created comprehensive graceful degradation system with multi-level fallbacks (full, partial, minimal)
- [2025-07-15] [Feature] Implemented feature-specific fallbacks for Monaco Editor, Terminal, Workflow Canvas, and Charts
- [2025-07-15] [Feature] Added progressive enhancement support with feature detection and network-aware components
- [2025-07-15] [Feature] Created server-side streaming error handler utility with retry logic and fallback data support
- [2025-07-15] [Bug Fix] Fixed nullish coalescing operator linting errors across all error components
- [2025-07-15] [Documentation] Created phase-3.4-error-handling-summary.md documenting comprehensive error handling implementation
