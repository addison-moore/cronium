# Changelog - 2025-10-06

## Feature: Server Archive/Delete System

### Added

- **Server Archive System** - Soft delete functionality for servers
  - Servers can be archived instead of permanently deleted
  - 30-day retention period before automatic deletion
  - Sensitive data (SSH keys, passwords) immediately purged on archive
  - Archived servers can be restored (requires credential reconfiguration)

- **Automatic Cleanup Service** - Background service for expired servers
  - Configurable via environment variables
  - Processes scheduled deletions automatically
  - Creates notifications at 7 days and 1 day before deletion
  - Batch processing for efficient handling

- **Archived Servers Management Page** - Dedicated UI for archived servers
  - Located at `/dashboard/servers/archived`
  - Shows deletion countdown for each server
  - Restore and permanent delete actions
  - Archive reason tracking

- **Impact Analysis** - Pre-deletion analysis
  - Shows affected events, configurations, and executions
  - Warns users about dependencies before deletion
  - Choice between archive (recommended) and permanent delete

### Modified

- **Server Deletion Flow** - Complete rewrite
  - Fixed foreign key constraint errors
  - Added transaction-based deletion for data consistency
  - Proper cascade handling for related records
  - Archive-first approach for safer deletions

- **Navigation Menu** - Added "Archived Servers" link
  - Appears for all users below main Servers link
  - Uses Archive icon from lucide-react

- **Storage Layer** - Enhanced server management
  - New methods for archive/restore operations
  - Notification tracking and management
  - Cleanup service integration

### Technical Changes

- Added `server_deletion_notifications` table for tracking warnings
- Added archive columns to servers table (isArchived, archivedAt, etc.)
- Created `ServerCleanupService` singleton for background processing
- Integrated cleanup service into app initialization (`/api/init/route.ts`)

### Configuration

New environment variables required:

```
SERVER_CLEANUP_ENABLED=true
SERVER_CLEANUP_INTERVAL=3600000  # 1 hour
SERVER_CLEANUP_BATCH_SIZE=10
SERVER_DELETION_WARNING_DAYS=[7,1]
```

### Bug Fixes

- Fixed server deletion failing due to foreign key constraints on `event_servers` table
- Fixed deletion order to properly handle cascade relationships
- Fixed TypeScript errors in UI components
- Fixed import paths for @cronium/ui components

### Development

- Created test script: `src/scripts/test-server-archive-flow.ts`
- Added comprehensive documentation in `_plans/server-removal/`
- Cleaned up console.log statements from production code

### Notes

- This is a simplified implementation suitable for early development
- No email notifications (in-app only)
- No bulk operations (single server only)
- Fixed 30-day retention period
- No unit tests (manual testing via script)
