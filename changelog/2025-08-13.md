# Changelog - 2025-08-13

## Payload Management Refactoring

### Overview

Refactored payload management to move payload creation from cronium-app to the orchestrator, improving architecture and reducing dependencies.

### Changes Made

#### 1. **Orchestrator Payload Service** [Feature]

- Created `internal/payload/service.go` in orchestrator
- Implements tar.gz payload creation with manifest files
- Generates checksums for payload verification
- Supports cleanup of old payloads

#### 2. **SSH Executor Payload Creation** [Feature]

- Added `internal/executors/ssh/executor_payload.go`
- Creates payloads locally in orchestrator from job script content
- Maintains backwards compatibility with legacy payload paths
- Extracts metadata from job for payload manifest

#### 3. **SSH Job Transformer Updates** [Refactor]

- Modified `ssh-job-transformer.ts` to send script content directly
- Removed dependency on PayloadService
- Includes environment variables and metadata in job payload
- No longer creates payload files in cronium-app

#### 4. **Docker Configuration** [Configuration]

- Removed payload volume mount from `docker-compose.dev.yml`
- Orchestrator no longer needs access to cronium-app's payload directory
- Simplified container dependencies

#### 5. **Binary Size Optimization** [Performance]

- Created platform-specific runner builds (linux/amd64, linux/arm64)
- Reduced runner binary size from 61 MB to 34 MB (44% reduction)
- Improved SSH cold start performance

#### 6. **Testing** [Testing]

- Created `test-payload-refactor.ts` to verify new payload flow
- Added `check-job-status.ts` utility script
- Successfully tested end-to-end job execution with new payload management

### Benefits

- **Better Architecture**: Payload creation is now colocated with execution logic
- **Reduced Dependencies**: Removed cross-container volume dependencies
- **Improved Performance**: Smaller runner binaries mean faster SSH deployments
- **Maintainability**: Cleaner separation of concerns between cronium-app and orchestrator

### Technical Details

- Orchestrator creates payloads in `/app/data/payloads/`
- Payloads include manifest.yaml with execution metadata
- Script content is sent via job.Execution.Script field
- Backwards compatible with existing payload paths

### Files Modified

- `/apps/orchestrator/internal/payload/service.go` (new)
- `/apps/orchestrator/internal/executors/ssh/executor_payload.go` (new)
- `/apps/orchestrator/internal/executors/ssh/executor.go`
- `/apps/orchestrator/internal/config/config.go`
- `/apps/cronium-app/src/lib/services/ssh-job-transformer.ts`
- `/infra/docker/docker-compose.dev.yml`
- `/apps/runner/cronium-runner/build-optimized.sh`

### Testing Results

- Job `job_test_1755113330323` completed successfully
- Payload created by orchestrator: `/app/data/payloads/job-job_test_1755113330323.tar.gz`
- SSH execution worked correctly with new payload flow
- No errors in job execution pipeline
